{% extends 'base.html' %} {% block title %}
<title>messages</title>
{% endblock %} {% block body %}
<div class="main-container">

  {% with flash_messages = get_flashed_messages() %}
    {% if flash_messages %}
      <div class="flash-container">
        {% for msg in flash_messages %}
          <div class="flash-message">{{ msg }}</div>
        {% endfor %}
      </div>
    {% endif %}
  {% endwith %}


    <div class="bookroom-header">
      <h1>PUBLIC</h1> 
      <div class="message-group">
      <div class ="bookroom-contents">
      <p class="bookroom-name">{{ bookroom.name | default("ブックルームの名前") }}</p>
        <p class="bookroom-description">{{bookroom.description | default("ブックルームの詳細") }}</p>
      </div>
      {% if bookroom.description is not none %}
      {% if selected_tags is not none %}
      <div class="tag-list-container">
        {% for tag in selected_tags %}
          <span class="tag-category-message"> {{ tag.name }} </span>
        {% endfor %}
      {% endif %}
    {% endif %}{% if bookroom.user_id == uid %}
      <button class="update-bookroom-button" id="update-bookroom-button">
        <img src="{{ url_for('static', filename='img/pen.png') }}" alt="アイコン" >
      </button>
     {% include 'modal/update-bookroom.html' %} {% endif %} 
      </div>
     </div>
    </div>  
  <div id="message-area">
      {% if messages|length > 0 %}
        {% for message in messages %} 
          {% if message.user_id == uid %}
    <div class="my-messages">
      <div class="message-and-trash-right">
        <p class="box box-right">{{ message.message }}</p>
      <form class ="delete-form" action="/public_bookrooms/{{ bookroom.id }}/messages/{{ message.id }}" method="POST">
        <input type="hidden" name="_method" value="DELETE"> 
      
        <button type="submit" class="delete-message-button">
        <img src="{{ url_for('static', filename='img/trash-can.png') }}" alt="アイコン" >
        </button>
      </form>  
      <span class="timestamp timestamp-right">{{ message.created_at.strftime("%Y/%m/%d %H:%M") }}</span>
      </div>
            <div class="reaction-zone reaction-zone-left">
              {% set mid = message.id %}

              {% for r in reactions %}
                {% set count = message_reaction_counts.get(mid, {}).get(r.id, 0) %}
                {% set active = (user_reactions[mid] == r.id) %}

              <form method="POST"
                    action="/public_bookrooms/{{ bookroom.id }}/messages/{{ message.id }}/reactions"
                    class="reaction-form">
                <input type="hidden" name="reaction_id" value="{{ r.id }}">
                <button type="submit"
                        class="reaction-item {% if active %}active{% endif %}">
                  {{ r.reaction_type }}
                  <span class="reaction-count">{{ count }}</span>
                </button>
              </form>
            {% endfor %}
            </div>   
    </div> 

      {% else %}
    <div class="messages">
      <div class="message-content-wrapper">
        <p class="user-name">{{message.user_name | default("メッセージテーブルのユーザーネーム")}}</p>
        <div class="icon-and-message-left">
          <img class="user-icon" src="{{message.icon_image}}" alt="ユーザーアイコン">
          <p class="box box-left">{{message.message| default("メッセージテーブルの内容")}}</p>
        </div> 
          <span class="timestamp timestamp-left">{{ message.created_at.strftime("%Y/%m/%d %H:%M") }}</span>
            <div class="reaction-zone reaction-zone-left">
              {% set mid = message.id %}
              {% for r in reactions %}
                {% set count = message_reaction_counts.get(mid, {}).get(r.id, 0) %}
                {% set active = (user_reactions[mid] == r.id) %}

                <form method="POST"
                      action="/public_bookrooms/{{ bookroom.id }}/messages/{{ message.id }}/reactions"
                      class="reaction-form">
                  <input type="hidden" name="reaction_id" value="{{ r.id }}">
                  <button type="submit"
                          class="reaction-item {% if active %}active{% endif %}">
                    {{ r.reaction_type }}
                    <span class="reaction-count">{{ count }}</span>
                  </button>
                </form>
              {% endfor %}

            </div>
        </div>  

      {% endif %}
    {% endfor %}
  {% else %}
      <p id="no-message">まだメッセージがありません</p>
  {% endif %} 
</div>
{% endblock %} {% block script %}
<div class="typing-box-wrapper">
      <form class="typing-box"
      method="POST"
      action="{{ url_for('create_message', bookroom_id=bookroom.id) }}"
      name="newMessageForm">

        <textarea name="message" id="message" maxlength="500" required></textarea>
        <input type="hidden" name="bookroom_id" value="{{bookroom.id}}" />
        <button type="submit" id="add-message-button">
          <img src="{{ url_for('static', filename='img/pen.png') }}" alt="アイコン" />
        </button>
      </form>
    </div>
<script type="text/javascript">
  // prettier-ignore
  const uid = JSON.parse('{{ uid|tojson }}');
</script>
<script
  src="{{url_for('static',filename='js/scroll-message.js')}}"
  type="text/javascript"
></script>
<script
  src="{{url_for('static',filename='js/bookroom/update-bookroom.js')}}"
  type="text/javascript"
></script>
{% endblock %}
